#!/bin/bash
# This file is @generated by <https://github.com/liblaf/copier-python>.
# DO NOT EDIT!
set -o errexit
set -o nounset
set -o pipefail

function get-docstring() {
  local file=$1
  docstring="$(sed '/"""$/q' "$file")"
  if diff --brief "$file" <(echo "$docstring") > /dev/null; then
    return
  else
    echo -n "$docstring"
  fi
}

function has() {
  type "$@" &> /dev/null
}

TEMPLATE="\
import lazy_loader as lazy

__getattr__, __dir__, __all__ = lazy.attach_stub(__name__, __file__)
del lazy"

git_root=$(git rev-parse --show-toplevel)
src_dir="$git_root/src"
if [[ -d $src_dir ]]; then
  while IFS= read -d '' -r file; do
    file="${file/%'.pyi'/'.py'}"
    if [[ ! -f $file ]]; then
      echo "$TEMPLATE" > "$file"
    else
      docstring=$(get-docstring "$file")
      {
        if [[ -n $docstring ]]; then
          echo "$docstring"
          echo
        fi
        echo "$TEMPLATE"
      } > "$file"
    fi
  done < <(find "$src_dir" -name '__init__.pyi' -type f -print0)
fi
